<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Basta Web</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
    <style>
        body {
            background: var(--gradient-purple);
            padding: 20px;
            min-height: 100vh;
            align-items: flex-start;
        }
        
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .admin-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px 30px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .admin-header h1 {
            margin: 0;
            font-size: 1.8em;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .admin-header .actions {
            display: flex;
            gap: 10px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-left: 4px solid var(--primary);
        }
        
        .stat-card.green {
            border-left-color: var(--success);
        }
        
        .stat-card.orange {
            border-left-color: var(--warning);
        }
        
        .stat-card.blue {
            border-left-color: #3b82f6;
        }
        
        .stat-card .icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--dark);
            margin: 10px 0;
        }
        
        .stat-card .label {
            color: var(--gray);
            font-size: 0.95em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .content-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 20px 25px;
            background: var(--gradient-1);
            color: white;
            font-weight: 700;
            font-size: 1.1em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .panel-body {
            padding: 20px 25px;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .sala-item {
            padding: 15px;
            margin: 10px 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .sala-item:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .sala-item.activa {
            border-left-color: var(--success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(6, 182, 212, 0.05) 100%);
        }
        
        .sala-item .codigo {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .sala-item .info {
            color: var(--gray);
            font-size: 0.9em;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .sala-item .badge {
            display: inline-block;
            padding: 3px 10px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .sala-item .badge.green {
            background: var(--success);
        }
        
        .sala-item .badge.orange {
            background: var(--warning);
        }
        
        .chat-message {
            padding: 10px 12px;
            margin: 8px 0;
            background: white;
            border-radius: var(--radius-md);
            border-left: 3px solid var(--primary);
        }
        
        .chat-message .meta {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.85em;
        }
        
        .chat-message .author {
            font-weight: 700;
            color: var(--primary);
        }
        
        .chat-message .room {
            color: var(--gray);
            font-size: 0.9em;
        }
        
        .chat-message .text {
            color: var(--dark);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .empty-state .icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        /* Modal de control de sala */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: var(--radius-xl);
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: slideInUp 0.3s ease-out;
        }
        
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .modal-header {
            margin-bottom: 25px;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.8em;
            color: var(--dark);
        }
        
        .modal-header .subtitle {
            color: var(--gray);
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: var(--light);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--primary);
        }
        
        .control-row .info {
            flex: 1;
        }
        
        .control-row .title {
            font-weight: 700;
            color: var(--dark);
            display: block;
            margin-bottom: 5px;
        }
        
        .control-row .desc {
            font-size: 0.85em;
            color: var(--gray);
        }
        
        .toggle-button {
            padding: 8px 16px;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .toggle-button.active {
            background: var(--success);
            color: white;
        }
        
        .toggle-button.inactive {
            background: var(--danger);
            color: white;
        }
        
        .toggle-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .modal-footer {
            margin-top: 25px;
            display: flex;
            gap: 10px;
        }
        
        @media (max-width: 968px) {
            .content-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Respuestas -->
    <div class="modal-overlay" id="respuestas-modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìã Respuestas de Jugadores - Sala <span id="respuestas-sala-codigo"></span></h2>
                <p class="subtitle">Letra: <span id="respuestas-letra">?</span> | Ronda: <span id="respuestas-ronda">1</span></p>
            </div>
            
            <div class="panel-body" id="respuestas-list" style="max-height: 400px; overflow-y: auto;">
                <div class="empty-state">
                    <div class="icon">üìã</div>
                    <p>Cargando respuestas...</p>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-join" onclick="cerrarRespuestasModal()" style="margin: 0; flex: 1;">Cerrar</button>
                <button class="btn btn-host" onclick="cargarRespuestas()" style="margin: 0; flex: 1;">üîÑ Actualizar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Control de Sala -->
    <div class="modal-overlay" id="control-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Controlar Sala <span id="modal-sala-codigo"></span></h2>
                <p class="subtitle">Administra las funcionalidades de esta sala</p>
            </div>
            
            <div class="control-row">
                <div class="info">
                    <span class="title">‚ö° Power-Ups</span>
                    <span class="desc">Habilidades especiales en el juego</span>
                </div>
                <button class="toggle-button active" data-feature="powerups_habilitados" id="btn-powerups">
                    ‚úì Activado
                </button>
            </div>
            
            <div class="control-row">
                <div class="info">
                    <span class="title">üí¨ Chat en Tiempo Real</span>
                    <span class="desc">Comunicaci√≥n entre jugadores</span>
                </div>
                <button class="toggle-button active" data-feature="chat_habilitado" id="btn-chat">
                    ‚úì Activado
                </button>
            </div>
            
            <div class="control-row">
                <div class="info">
                    <span class="title">üîä Efectos de Sonido</span>
                    <span class="desc">Sonidos durante el juego</span>
                </div>
                <button class="toggle-button active" data-feature="sonidos_habilitados" id="btn-sonidos">
                    ‚úì Activado
                </button>
            </div>
            
            <div class="control-row">
                <div class="info">
                    <span class="title">‚úÖ Sistema de Validaci√≥n</span>
                    <span class="desc">Votaci√≥n para respuestas dudosas</span>
                </div>
                <button class="toggle-button active" data-feature="validacion_activa" id="btn-validacion">
                    ‚úì Activado
                </button>
            </div>
            
            <div class="control-row" id="control-pausa" style="display: none;">
                <div class="info">
                    <span class="title">‚è∏Ô∏è Pausar Ronda</span>
                    <span class="desc">Pausar/despausar la ronda en curso. Los jugadores no podr√°n hacer nada mientras est√© pausada.</span>
                </div>
                <button class="toggle-button inactive" id="btn-pausar" onclick="togglePausa()">
                    ‚è∏Ô∏è Pausar
                </button>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-join" onclick="cerrarModal()" style="margin: 0; flex: 1;">Cerrar</button>
                <button class="btn btn-host" onclick="verChatModal()" style="margin: 0; flex: 1;">üí¨ Ver Chat</button>
                <button class="btn btn-admin" onclick="verRespuestasModal()" style="margin: 0; flex: 1; background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);">üìã Ver Respuestas</button>
            </div>
        </div>
    </div>

    <div class="admin-container">
        <!-- Header -->
        <div class="admin-header">
            <div>
                <span style="font-size: 1.5em; margin-right: 10px;">üîê</span>
                <h1 style="display: inline;">Panel de Administraci√≥n</h1>
            </div>
            <div class="actions">
                <button class="btn btn-join" onclick="location.reload()" style="margin: 0;">üîÑ Actualizar</button>
                <button class="btn btn-danger" onclick="cerrarSesion()" style="margin: 0; background: var(--danger);">üö™ Salir</button>
            </div>
        </div>
        
        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="icon">üè†</div>
                <div class="value" id="stat-salas">0</div>
                <div class="label">Total Salas</div>
            </div>
            
            <div class="stat-card green">
                <div class="icon">üéÆ</div>
                <div class="value" id="stat-activas">0</div>
                <div class="label">Salas Activas</div>
            </div>
            
            <div class="stat-card blue">
                <div class="icon">üë•</div>
                <div class="value" id="stat-jugadores">0</div>
                <div class="label">Jugadores Online</div>
            </div>
            
            <div class="stat-card orange">
                <div class="icon">üí¨</div>
                <div class="value" id="stat-mensajes">0</div>
                <div class="label">Mensajes Chat</div>
            </div>
        </div>
        
        <!-- Contenido Principal -->
        <div class="content-grid">
            <!-- Salas Activas -->
            <div class="panel">
                <div class="panel-header">
                    <span>üè†</span>
                    Salas del Sistema
                </div>
                <div class="panel-body" id="salas-list">
                    <div class="empty-state">
                        <div class="icon">üîç</div>
                        <p>Cargando salas...</p>
                    </div>
                </div>
            </div>
            
            <!-- Monitor de Chat -->
            <div class="panel">
                <div class="panel-header">
                    <span>üí¨</span>
                    Monitor de Chat
                    <span id="selected-room" style="margin-left: auto; font-weight: 400; font-size: 0.9em; opacity: 0.9;"></span>
                </div>
                <div class="panel-body" id="chat-monitor">
                    <div class="empty-state">
                        <div class="icon">üí¨</div>
                        <p>Selecciona una sala para ver los mensajes</p>
                    </div>
                </div>
            </div>
            
            <!-- Logs del Servidor -->
            <div class="panel" style="grid-column: 1 / -1;">
                <div class="panel-header">
                    <span>üìú</span>
                    Logs del Servidor
                    <div style="margin-left: auto; display: flex; gap: 10px;">
                        <button onclick="toggleAutoScroll()" id="btn-autoscroll" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.4); color: white; border-radius: 4px; padding: 4px 10px; cursor: pointer; font-size: 0.8em;">‚¨áÔ∏è Auto-Scroll: ON</button>
                    </div>
                </div>
                <div class="panel-body" id="server-logs" style="background: #1e1e1e; color: #d4d4d4; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85em; padding: 0; height: 300px; overflow-y: auto;">
                    <div style="padding: 20px; text-align: center; color: #666;">
                        <p>Cargando logs...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurar Socket.IO con opciones de reconexi√≥n
        const socket = io({
            transports: ['websocket', 'polling'],
            upgrade: true,
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionDelayMax: 5000,
            timeout: 20000
        });
        let currentRoom = null;
        let updateInterval = null;
        let currentSalaData = null;
        let autoScroll = true;
        let lastLogCount = 0;
        
        // Cargar Logs
        async function cargarLogs() {
            try {
                const res = await fetch('/api/admin/logs');
                const data = await res.json();
                
                if (data.ok) {
                    const logsContainer = document.getElementById('server-logs');
                    
                    // Si no hay logs
                    if (data.logs.length === 0) {
                        logsContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;"><p>No hay logs registrados</p></div>';
                        return;
                    }
                    
                    // Si hay nuevos logs (o es la primera carga)
                    if (data.logs.length !== lastLogCount) {
                        let html = '<table style="width: 100%; border-collapse: collapse;">';
                        
                        data.logs.forEach((log, index) => {
                            const isEven = index % 2 === 0;
                            // Colorear seg√∫n tipo de mensaje
                            let color = '#d4d4d4'; // Default (info)
                            if (log.msg.includes('‚ö†Ô∏è') || log.msg.toLowerCase().includes('warning')) color = '#fca5a5'; // Red/Orange
                            if (log.msg.includes('‚úÖ') || log.msg.toLowerCase().includes('success')) color = '#86efac'; // Green
                            if (log.msg.includes('‚ùå') || log.msg.includes('üö´') || log.msg.toLowerCase().includes('error')) color = '#f87171'; // Red
                            if (log.msg.includes('ü§ñ')) color = '#93c5fd'; // Blue (IA)
                            
                            html += `
                                <tr style="background: ${isEven ? 'rgba(255,255,255,0.03)' : 'transparent'};">
                                    <td style="padding: 2px 8px; color: #666; border-right: 1px solid #333; width: 80px; white-space: nowrap; vertical-align: top;">${log.time}</td>
                                    <td style="padding: 2px 8px; color: ${color}; white-space: pre-wrap; word-break: break-word;">${log.msg}</td>
                                </tr>
                            `;
                        });
                        
                        html += '</table>';
                        logsContainer.innerHTML = html;
                        lastLogCount = data.logs.length;
                        
                        if (autoScroll) {
                            logsContainer.scrollTop = logsContainer.scrollHeight;
                        }
                    }
                }
            } catch (error) {
                console.error('Error al cargar logs:', error);
            }
        }

        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            const btn = document.getElementById('btn-autoscroll');
            if (autoScroll) {
                btn.textContent = '‚¨áÔ∏è Auto-Scroll: ON';
                btn.style.background = 'rgba(255,255,255,0.2)';
            } else {
                btn.textContent = '‚¨áÔ∏è Auto-Scroll: OFF';
                btn.style.background = 'rgba(255,255,255,0.05)';
            }
        }

        // Cargar estad√≠sticas
        async function cargarEstadisticas() {
            try {
                const res = await fetch('/api/admin/estadisticas');
                const data = await res.json();
                
                if (data.ok) {
                    document.getElementById('stat-salas').textContent = data.estadisticas.total_salas;
                    document.getElementById('stat-activas').textContent = data.estadisticas.salas_activas;
                    document.getElementById('stat-jugadores').textContent = data.estadisticas.total_jugadores;
                    document.getElementById('stat-mensajes').textContent = data.estadisticas.total_mensajes;
                }
            } catch (error) {
                console.error('Error al cargar estad√≠sticas:', error);
            }
        }
        
        // Cargar salas
        async function cargarSalas() {
            try {
                const res = await fetch('/api/admin/salas');
                const data = await res.json();
                
                if (data.ok) {
                    const salasList = document.getElementById('salas-list');
                    
                    if (data.salas.length === 0) {
                        salasList.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">üè†</div>
                                <p>No hay salas activas</p>
                            </div>
                        `;
                        return;
                    }
                    
                    salasList.innerHTML = '';
                    data.salas.forEach(sala => {
                        let estadoBadge = '';
                        if (sala.en_curso) {
                            estadoBadge = sala.pausada ? 
                                '<span class="badge" style="background: #f59e0b;">‚è∏Ô∏è Pausada</span>' : 
                                '<span class="badge green">üéÆ En juego</span>';
                        } else {
                            estadoBadge = '<span class="badge orange">‚è∏Ô∏è Esperando</span>';
                        }
                        
                        const div = document.createElement('div');
                        div.className = `sala-item ${sala.en_curso ? 'activa' : ''}`;
                        div.innerHTML = `
                            <div class="codigo">${sala.codigo}</div>
                            <div class="info">
                                <span>üëë ${sala.anfitrion}</span>
                                <span>üë• ${sala.jugadores.length} jugadores</span>
                                <span>üéØ ${sala.modo_juego}</span>
                                <span>üìù Ronda ${sala.ronda_actual}/${sala.total_rondas}</span>
                                <span>üí¨ ${sala.num_mensajes} msgs</span>
                            </div>
                            <div style="margin-top: 8px;">${estadoBadge}</div>
                            <div style="margin-top: 8px; font-size: 0.85em; color: var(--gray);">
                                <span>Click: ver chat ‚Ä¢ Doble-click: controlar</span>
                            </div>
                        `;
                        div.onclick = () => verChat(sala.codigo);
                        div.ondblclick = () => abrirControlSala(sala);
                        salasList.appendChild(div);
                    });
                }
            } catch (error) {
                console.error('Error al cargar salas:', error);
            }
        }
        
        // Ver chat de una sala
        async function verChat(codigo) {
            currentRoom = codigo;
            document.getElementById('selected-room').textContent = `Sala: ${codigo}`;
            
            try {
                const res = await fetch(`/api/admin/sala/${codigo}/chat`);
                const data = await res.json();
                
                if (data.ok) {
                    const chatMonitor = document.getElementById('chat-monitor');
                    
                    if (data.mensajes.length === 0) {
                        chatMonitor.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">üí¨</div>
                                <p>No hay mensajes en esta sala</p>
                            </div>
                        `;
                        return;
                    }
                    
                    chatMonitor.innerHTML = '';
                    data.mensajes.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'chat-message';
                        div.innerHTML = `
                            <div class="meta">
                                <span class="author">${msg.jugador}</span>
                                <span class="room">${new Date(msg.timestamp).toLocaleTimeString()}</span>
                            </div>
                            <div class="text">${msg.mensaje}</div>
                        `;
                        chatMonitor.appendChild(div);
                    });
                    
                    // Scroll al final
                    chatMonitor.scrollTop = chatMonitor.scrollHeight;
                }
            } catch (error) {
                console.error('Error al cargar chat:', error);
            }
        }
        
        // Escuchar nuevos mensajes en tiempo real
        socket.on('nuevo_mensaje_chat', (data) => {
            // Si estamos viendo esa sala, actualizar
            if (currentRoom) {
                verChat(currentRoom);
            }
            // Actualizar estad√≠sticas
            cargarEstadisticas();
        });
        
        // Escuchar cambios en las salas
        socket.on('player_joined', () => {
            cargarSalas();
            cargarEstadisticas();
        });
        
        socket.on('start_game', () => {
            cargarSalas();
            cargarEstadisticas();
        });
        
        // Abrir modal de control de sala
        async function abrirControlSala(sala) {
            currentSalaData = sala;
            document.getElementById('modal-sala-codigo').textContent = sala.codigo;
            
            // Mostrar/ocultar control de pausa seg√∫n si hay ronda en curso
            const controlPausa = document.getElementById('control-pausa');
            const btnPausar = document.getElementById('btn-pausar');
            if (sala.en_curso) {
                controlPausa.style.display = 'flex';
                // Cargar estado de pausa
                try {
                    const res = await fetch(`/api/admin/sala/${sala.codigo}`);
                    const data = await res.json();
                    if (data.ok) {
                        const pausada = data.sala.pausada || false;
                        if (pausada) {
                            btnPausar.classList.remove('inactive');
                            btnPausar.classList.add('active');
                            btnPausar.textContent = '‚ñ∂Ô∏è Reanudar';
                        } else {
                            btnPausar.classList.remove('active');
                            btnPausar.classList.add('inactive');
                            btnPausar.textContent = '‚è∏Ô∏è Pausar';
                        }
                    }
                } catch (error) {
                    console.error('Error:', error);
                }
            } else {
                controlPausa.style.display = 'none';
            }
            
            // Obtener configuraci√≥n completa de la sala
            try {
                const res = await fetch(`/api/admin/sala/${sala.codigo}`);
                const data = await res.json();
                
                if (data.ok) {
                    const config = data.sala;
                    
                    // Actualizar botones seg√∫n configuraci√≥n
                    actualizarBotonToggle('btn-powerups', config.powerups_habilitados);
                    actualizarBotonToggle('btn-chat', config.chat_habilitado);
                    actualizarBotonToggle('btn-sonidos', config.sonidos_habilitados);
                    actualizarBotonToggle('btn-validacion', config.validacion_activa);
                }
            } catch (error) {
                console.error('Error al cargar configuraci√≥n:', error);
            }
            
            // Mostrar modal
            document.getElementById('control-modal').classList.add('show');
        }
        
        // Toggle pausa
        async function togglePausa() {
            if (!currentSalaData) return;
            
            try {
                const res = await fetch(`/api/admin/sala/${currentSalaData.codigo}/pausar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await res.json();
                
                if (data.ok) {
                    const btnPausar = document.getElementById('btn-pausar');
                    if (data.pausada) {
                        btnPausar.classList.remove('inactive');
                        btnPausar.classList.add('active');
                        btnPausar.textContent = '‚ñ∂Ô∏è Reanudar';
                    } else {
                        btnPausar.classList.remove('active');
                        btnPausar.classList.add('inactive');
                        btnPausar.textContent = '‚è∏Ô∏è Pausar';
                    }
                    mostrarNotificacion(data.message);
                    // Actualizar estado en currentSalaData
                    currentSalaData.pausada = data.pausada;
                    // Recargar salas para actualizar el badge
                    cargarSalas();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }
        
        // Ver respuestas
        async function verRespuestasModal() {
            if (!currentSalaData) return;
            
            document.getElementById('respuestas-sala-codigo').textContent = currentSalaData.codigo;
            document.getElementById('respuestas-modal').classList.add('show');
            await cargarRespuestas();
        }
        
        async function cargarRespuestas() {
            if (!currentSalaData) return;
            
            try {
                // Obtener estado actual de la sala para verificar pausa
                const resSala = await fetch(`/api/admin/sala/${currentSalaData.codigo}`);
                const dataSala = await resSala.json();
                const estaPausada = dataSala.ok && dataSala.sala.pausada;
                
                const res = await fetch(`/api/admin/sala/${currentSalaData.codigo}/respuestas`);
                const data = await res.json();
                
                if (data.ok) {
                    document.getElementById('respuestas-letra').textContent = data.letra;
                    document.getElementById('respuestas-ronda').textContent = data.ronda;
                    
                    const respuestasList = document.getElementById('respuestas-list');
                    
                    if (Object.keys(data.respuestas).length === 0 && data.jugadores_sin_respuestas.length === 0) {
                        respuestasList.innerHTML = `
                            <div class="empty-state">
                                <div class="icon">üìã</div>
                                <p>No hay respuestas a√∫n</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    
                    // Mostrar respuestas
                    for (const [jugador, info] of Object.entries(data.respuestas)) {
                        html += `
                            <div style="padding: 15px; margin: 10px 0; background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(6, 182, 212, 0.1) 100%); border-radius: var(--radius-md); border-left: 4px solid var(--success);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: var(--dark); font-size: 1.1em;">${jugador}</strong>
                                        <span style="display: inline-block; padding: 3px 10px; background: #6b7280; color: white; border-radius: 12px; font-size: 0.75em; margin-left: 8px; font-weight: 600;">ID: ${info.player_id}</span>
                                    </div>
                                    ${currentSalaData.en_curso && estaPausada ? `
                                        <button class="btn btn-danger" onclick="expulsarJugador('${info.player_id}')" style="padding: 6px 12px; font-size: 0.85em; margin: 0;">
                                            üö´ Expulsar
                                        </button>
                                    ` : ''}
                                </div>
                                <div style="display: grid; gap: 8px;">
                        `;
                        
                        for (const [categoria, respuesta] of Object.entries(info.respuestas)) {
                            html += `
                                <div style="padding: 8px 12px; background: white; border-radius: var(--radius-sm);">
                                    <strong style="color: var(--primary); font-size: 0.9em;">${categoria}:</strong>
                                    <span style="color: var(--dark); margin-left: 8px;">${respuesta || '(vac√≠o)'}</span>
                                </div>
                            `;
                        }
                        
                        html += `</div></div>`;
                    }
                    
                    // Mostrar jugadores sin respuestas
                    if (data.jugadores_sin_respuestas.length > 0) {
                        html += `
                            <div style="padding: 15px; margin: 10px 0; background: linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(251, 146, 60, 0.1) 100%); border-radius: var(--radius-md); border-left: 4px solid var(--warning);">
                                <strong style="color: var(--dark);">Jugadores sin respuestas:</strong>
                                <div style="margin-top: 8px;">
                        `;
                        for (const jugador of data.jugadores_sin_respuestas) {
                            html += `<span style="display: inline-block; padding: 5px 12px; background: white; border-radius: 8px; margin: 4px; font-size: 0.9em;">${jugador}</span>`;
                        }
                        html += `</div></div>`;
                    }
                    
                    respuestasList.innerHTML = html;
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }
        
        async function expulsarJugador(playerId) {
            if (!currentSalaData) return;
            if (!confirm('¬øEst√°s seguro de expulsar a este jugador?')) return;
            
            try {
                const res = await fetch(`/api/admin/sala/${currentSalaData.codigo}/expulsar`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ player_id: playerId })
                });
                
                const data = await res.json();
                
                if (data.ok) {
                    mostrarNotificacion(data.message);
                    cargarRespuestas();
                    cargarSalas();
                    cargarEstadisticas();
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error de conexi√≥n');
            }
        }
        
        function cerrarRespuestasModal() {
            document.getElementById('respuestas-modal').classList.remove('show');
        }
        
        function actualizarBotonToggle(btnId, estado) {
            const btn = document.getElementById(btnId);
            if (estado) {
                btn.classList.remove('inactive');
                btn.classList.add('active');
                btn.textContent = '‚úì Activado';
            } else {
                btn.classList.remove('active');
                btn.classList.add('inactive');
                btn.textContent = '‚úó Desactivado';
            }
        }
        
        // Configurar listeners de los botones de toggle
        document.querySelectorAll('.toggle-button').forEach(btn => {
            btn.addEventListener('click', async function() {
                if (!currentSalaData) return;
                
                const feature = this.dataset.feature;
                const isActive = this.classList.contains('active');
                const newState = !isActive;
                
                // Cambiar configuraci√≥n en el servidor
                try {
                    const res = await fetch('/api/admin/cambiar_config', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({
                            codigo: currentSalaData.codigo,
                            feature: feature,
                            value: newState
                        })
                    });
                    
                    const data = await res.json();
                    
                    if (data.ok) {
                        // Actualizar UI
                        actualizarBotonToggle(this.id, newState);
                        mostrarNotificacion(`‚úì ${feature} ${newState ? 'activado' : 'desactivado'}`);
                    } else {
                        alert('Error al cambiar configuraci√≥n');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error de conexi√≥n');
                }
            });
        });
        
        function cerrarModal() {
            document.getElementById('control-modal').classList.remove('show');
            currentSalaData = null;
        }
        
        function verChatModal() {
            if (currentSalaData) {
                cerrarModal();
                verChat(currentSalaData.codigo);
            }
        }
        
        function mostrarNotificacion(mensaje) {
            const notif = document.createElement('div');
            notif.textContent = mensaje;
            notif.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                background: var(--gradient-4);
                color: white;
                border-radius: 12px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                z-index: 10001;
                font-weight: 600;
                animation: slideInRight 0.3s ease-out;
            `;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }
        
        // Cerrar modal al hacer click fuera
        document.getElementById('control-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarModal();
            }
        });
        
        document.getElementById('respuestas-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                cerrarRespuestasModal();
            }
        });
        
        // Cerrar sesi√≥n
        function cerrarSesion() {
            if (confirm('¬øSeguro que quieres cerrar sesi√≥n?')) {
                window.location.href = '/admin/logout';
            }
        }
        
        // Cargar todo al iniciar
        window.addEventListener('load', () => {
            cargarEstadisticas();
            cargarSalas();
            cargarLogs();
            
            // Actualizar cada 5 segundos
            updateInterval = setInterval(() => {
                cargarEstadisticas();
                cargarSalas();
                cargarLogs();
                if (currentRoom) {
                    verChat(currentRoom);
                }
            }, 2000); // Actualizar logs m√°s r√°pido (2s)
        });
        
        // Limpiar al salir
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });
    </script>
</body>
</html>

