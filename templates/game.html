<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>¬°BASTA! - Jugando</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='sounds.js') }}"></script>
    <style>
        body {
            background: var(--gradient-purple);
            padding: clamp(10px, 1.5vw, 20px);
            min-height: 100vh;
            align-items: flex-start;
        }
        
        .game-layout {
            display: grid;
            grid-template-columns: 1fr clamp(250px, 20vw, 300px);
            gap: clamp(12px, 1.5vw, 20px);
            max-width: min(1000px, 95vw);
            margin: 0 auto;
            width: 100%;
        }
        
        .game-main {
            display: flex;
            flex-direction: column;
            gap: clamp(12px, 1.5vw, 20px);
        }
        
        .game-sidebar {
            display: flex;
            flex-direction: column;
            gap: clamp(10px, 1.2vw, 15px);
        }
        
        /* Header con timer */
        .game-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: clamp(12px, 1.5vw, 18px) clamp(14px, 1.8vw, 20px);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .letra-display {
            font-size: clamp(2em, 3.5vw, 3em);
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            line-height: 1;
        }
        
        .ronda-info {
            color: var(--gray);
            font-size: clamp(0.75em, 1vw, 0.85em);
            font-weight: 600;
            margin-top: clamp(4px, 0.6vw, 6px);
        }
        
        /* Timer circular */
        .timer-container {
            position: relative;
            width: clamp(65px, 7vw, 80px);
            height: clamp(65px, 7vw, 80px);
        }
        
        .timer-circle {
            transform: rotate(-90deg);
        }
        
        .timer-circle-bg {
            fill: none;
            stroke: var(--light);
            stroke-width: 8;
        }
        
        .timer-circle-progress {
            fill: none;
            stroke: url(#gradient);
            stroke-width: 8;
            stroke-linecap: round;
            transition: stroke-dashoffset 1s linear;
        }
        
        .timer-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(1.4em, 2vw, 1.8em);
            font-weight: 700;
            color: var(--dark);
        }
        
        .timer-text.warning {
            color: var(--danger);
            animation: pulse 1s ease-in-out infinite;
        }
        
        /* Categor√≠as */
        .game-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: clamp(14px, 1.8vw, 20px);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .categories-grid {
            display: grid;
            gap: clamp(8px, 1vw, 12px);
        }
        
        .category-row {
            display: flex;
            gap: clamp(8px, 1vw, 12px);
            align-items: flex-start;
            padding: clamp(8px, 1vw, 10px);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: var(--radius-md);
            border-left: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .category-label {
            min-width: clamp(120px, 15vw, 160px);
            flex-shrink: 0;
        }
        
        .category-row:hover {
            border-left-color: var(--primary);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
        }
        
        .category-label {
            font-weight: 600;
            color: var(--dark);
            font-size: clamp(0.8em, 1vw, 0.9em);
            display: flex;
            align-items: center;
            gap: clamp(4px, 0.6vw, 6px);
        }
        
        .category-input {
            width: 100%;
            padding: clamp(8px, 1vw, 10px) clamp(10px, 1.2vw, 12px);
            border: 2px solid var(--light);
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: clamp(0.85em, 1vw, 0.95em);
            transition: all 0.3s ease;
            background: white;
        }
        
        .category-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            transform: translateY(-2px);
        }
        
        .category-input.filled {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }
        
        /* Validaci√≥n IA */
        .validacion-ia {
            display: none;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 4px;
        }
        
        .badge-ia {
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .btn-apelar {
            padding: 4px 10px;
            font-size: 0.8em;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-apelar:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }
        
        /* Power-Ups Panel */
        .powerups-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: clamp(14px, 1.8vw, 20px);
        }
        
        .powerups-title {
            font-size: clamp(1em, 1.3vw, 1.1em);
            font-weight: 700;
            color: var(--dark);
            margin-bottom: clamp(10px, 1.2vw, 15px);
            display: flex;
            align-items: center;
            gap: clamp(6px, 0.8vw, 8px);
        }
        
        .powerup-item {
            padding: clamp(10px, 1.2vw, 12px);
            margin: clamp(6px, 0.8vw, 8px) 0;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-radius: var(--radius-md);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .powerup-item:hover:not(.disabled) {
            border-color: var(--primary);
            transform: translateX(5px);
        }
        
        .powerup-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .powerup-info .icon {
            font-size: 1.5em;
            margin-right: 8px;
        }
        
        .powerup-info .name {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9em;
        }
        
        .powerup-count {
            background: var(--gradient-1);
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 0.85em;
        }
        
        /* Chat Mini */
        .chat-mini {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: clamp(250px, 25vw, 300px);
        }
        
        .chat-header-mini {
            background: var(--gradient-3);
            color: white;
            padding: clamp(10px, 1.2vw, 12px) clamp(12px, 1.5vw, 15px);
            font-weight: 700;
            font-size: clamp(0.85em, 1vw, 0.9em);
            display: flex;
            align-items: center;
            gap: clamp(6px, 0.8vw, 8px);
        }
        
        .chat-messages-mini {
            flex: 1;
            overflow-y: auto;
            padding: clamp(8px, 1vw, 10px);
            display: flex;
            flex-direction: column;
            gap: clamp(6px, 0.8vw, 8px);
        }
        
        .chat-message-mini {
            padding: clamp(6px, 0.8vw, 8px) clamp(8px, 1vw, 10px);
            border-radius: var(--radius-sm);
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            font-size: clamp(0.8em, 0.95vw, 0.85em);
        }
        
        .chat-message-mini .author {
            font-weight: 700;
            color: var(--primary);
            font-size: clamp(0.85em, 1vw, 0.9em);
        }
        
        .chat-input-mini {
            padding: clamp(8px, 1vw, 10px);
            border-top: 1px solid var(--light);
            background: white;
            display: flex;
            gap: clamp(6px, 0.8vw, 8px);
        }
        
        .chat-input-mini input {
            flex: 1;
            padding: clamp(6px, 0.8vw, 8px) clamp(10px, 1.2vw, 12px);
            border: 2px solid var(--light);
            border-radius: var(--radius-sm);
            font-size: 0.85em;
        }
        
        .chat-input-mini button {
            padding: 8px 15px;
            background: var(--gradient-3);
            color: white;
            border: none;
            border-radius: var(--radius-sm);
            font-weight: 600;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        /* Bot√≥n BASTA */
        #basta-btn {
            width: 100%;
            padding: clamp(10px, 1.2vw, 14px);
            font-size: clamp(1em, 1.3vw, 1.1em);
            font-weight: 700;
            letter-spacing: clamp(0.5px, 0.1vw, 1px);
            background: var(--gradient-2);
        }
        
        /* Modal de validaci√≥n */
        #validation-modal, #apelacion-modal {
            display: none;
            position: fixed;
            z-index: 15000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }
        
        #validation-modal.show, #apelacion-modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .validation-content {
            background: white;
            padding: 30px;
            border-radius: var(--radius-xl);
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .validation-content h3 {
            font-size: 1.5em;
            color: var(--dark);
            margin-bottom: 15px;
        }
        
        .validation-content .answer {
            padding: 15px;
            background: var(--light);
            border-radius: var(--radius-md);
            font-size: 1.2em;
            font-weight: 700;
            text-align: center;
            margin: 20px 0;
        }
        
        .validation-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .validation-buttons .btn {
            margin: 0;
        }
        
        /* Animaci√≥n de actualizaci√≥n de puntos */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); color: #10b981; }
            100% { transform: scale(1); }
        }
        
        /* Overlay de Validando IA */
        #validando-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.95) 0%, rgba(139, 92, 246, 0.95) 100%);
            backdrop-filter: blur(15px);
            z-index: 15000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .validando-content {
            text-align: center;
            color: white;
        }
        
        .loader-spinner {
            width: 80px;
            height: 80px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-top: 6px solid white;
            border-radius: 50%;
            margin: 0 auto 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .validando-title {
            font-size: 2.5em;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .validando-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .progress-dots {
            display: flex;
            justify-content: center;
            gap: 12px;
        }
        
        .progress-dots .dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: dotPulse 1.4s infinite ease-in-out;
        }
        
        .progress-dots .dot:nth-child(1) {
            animation-delay: 0s;
        }
        
        .progress-dots .dot:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .progress-dots .dot:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes dotPulse {
            0%, 80%, 100% {
                transform: scale(0.6);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* Bot√≥n flotante pulsante */
        @keyframes pulse-btn {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 12px 35px rgba(16, 185, 129, 0.6);
            }
        }
        
        #btn-volver-resultados:hover {
            transform: scale(1.1) !important;
            box-shadow: 0 12px 40px rgba(16, 185, 129, 0.7) !important;
        }
        
        /* Modal de Resultados */
        #resultados-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 12000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .resultados-modal-content {
            background: white;
            border-radius: var(--radius-xl);
            max-width: 700px;
            width: 100%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .resultados-header {
            padding: 30px 30px 20px;
            border-bottom: 2px solid var(--light);
            text-align: center;
        }
        
        .resultados-body {
            padding: 25px 30px;
            overflow-y: auto;
            flex: 1;
        }
        
        .resultados-footer {
            padding: 20px 30px 30px;
            border-top: 2px solid var(--light);
        }
        
        /* Responsive - Solo para m√≥viles/tablets peque√±as */
        @media (max-width: 768px) {
            .game-layout {
                grid-template-columns: 1fr;
            }
            
            .category-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .game-sidebar {
                order: -1; /* Mover sidebar arriba en m√≥viles */
            }
            
            .validando-title {
                font-size: 1.8em;
            }
            
            .validando-subtitle {
                font-size: 1em;
            }
            
            .resultados-modal-content {
                max-width: 95%;
                max-height: 90vh;
            }
            
            .resultados-header h2 {
                font-size: 1.5em;
            }
            
            .resultados-footer > div {
                grid-template-columns: 1fr !important;
                gap: 10px !important;
            }
            
            #btn-volver-resultados {
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <!-- Modal de Validaci√≥n -->
    <div id="validation-modal">
        <div class="validation-content">
            <h3>ü§î Validar Respuesta</h3>
            <p><strong id="val-player"></strong> respondi√≥ en <strong id="val-category"></strong>:</p>
            <div class="answer" id="val-answer"></div>
            <p style="text-align: center; margin: 15px 0;">¬øEs v√°lida esta respuesta?</p>
            <div class="validation-buttons">
                <button class="btn btn-host" onclick="votarValidacion('valida')">‚úì S√≠, es v√°lida</button>
                <button class="btn btn-danger" onclick="votarValidacion('invalida')">‚úó No es v√°lida</button>
            </div>
        </div>
    </div>

    <!-- Modal de Apelaci√≥n -->
    <div id="apelacion-modal">
        <div class="validation-content">
            <h3>‚ö†Ô∏è Votaci√≥n de Apelaci√≥n</h3>
            <p><strong id="apel-player"></strong> est√° apelando su respuesta en <strong id="apel-category"></strong>:</p>
            <div class="answer" id="apel-answer"></div>
            <p style="text-align: center; margin: 15px 0; color: var(--gray); font-size: 0.9em;">
                ü§ñ La IA marc√≥ esta respuesta como inv√°lida<br>
                ¬øCrees que deber√≠a ser aceptada?
            </p>
            <div class="validation-buttons">
                <button class="btn btn-host" onclick="votarApelacion('valida')">‚úì S√≠, es v√°lida</button>
                <button class="btn btn-danger" onclick="votarApelacion('invalida')">‚úó No es v√°lida</button>
            </div>
        </div>
    </div>

    <!-- Overlay de Validando IA -->
    <div id="validando-overlay" style="display: none;">
        <div class="validando-content">
            <div class="loader-spinner"></div>
            <h2 class="validando-title">ü§ñ Validando respuestas con IA...</h2>
            <p class="validando-subtitle">Por favor espera un momento</p>
            <div class="progress-dots">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
            </div>
        </div>
    </div>

    <!-- Modal de Resultados -->
    <div id="resultados-modal" style="display: none;">
        <div class="resultados-modal-content">
            <div class="resultados-header">
                <h2 style="margin: 0; font-size: 2em; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                    üèÜ <span id="resultados-titulo-modal">Resultados</span>
                </h2>
            </div>
            <div class="resultados-body">
                <div id="resultados-puntuaciones-modal" style="margin-bottom: 25px;"></div>
            </div>
            <div class="resultados-footer">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <button class="btn" id="btn-ver-detalle" style="font-size: 1em; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                        üìã Ver Respuestas
                    </button>
                    <button class="btn btn-host" id="btn-continuar-modal" style="font-size: 1em;">
                        Continuar ‚û°Ô∏è
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√≥n flotante para volver a resultados -->
    <button id="btn-volver-resultados" style="display: none; position: fixed; bottom: 30px; right: 30px; z-index: 11000; padding: 15px 25px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 50px; font-size: 1.1em; font-weight: 700; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4); cursor: pointer; transition: all 0.3s ease; animation: pulse-btn 2s infinite;">
        üèÜ Ver Puntuaciones
    </button>

    <!-- Overlay de Resultados -->
    <div id="results-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); z-index: 10000; overflow-y: auto;">
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100%;">
            <div class="results-content" style="background: white; padding: 40px; border-radius: var(--radius-xl); max-width: 800px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);">
                <h2 id="results-title" style="font-size: 2.5em; font-weight: 700; text-align: center; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; margin-bottom: 30px;">üèÜ Resultados</h2>
                <div id="results-body"></div>
                <button class="btn btn-host" onclick="volverASala()" style="margin-top: 30px;">Continuar</button>
            </div>
        </div>
    </div>

    <!-- Juego Finalizado -->
    <div id="juego-finalizado-msg" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 10000; align-items: center; justify-content: center; padding: 20px;">
        <div style="background: white; padding: clamp(30px, 5vw, 50px); border-radius: 24px; text-align: center; max-width: 500px; width: 100%;">
            <h1 style="font-size: clamp(2em, 5vw, 3em); margin: 0;">üéâ</h1>
            <h2 style="font-size: clamp(1.5em, 4vw, 2em); margin: clamp(15px, 3vw, 20px) 0;">¬°Juego Finalizado!</h2>
            <p style="color: var(--gray); margin-bottom: clamp(20px, 4vw, 30px); font-size: clamp(0.9rem, 1.5vw, 1rem);">Gracias por jugar</p>
            <h3 style="font-size: clamp(1em, 2.5vw, 1.3em); margin-bottom: clamp(15px, 3vw, 20px); color: var(--dark);">¬øQuieres jugar otra vez?</h3>
            <div style="display: flex; gap: clamp(10px, 2vw, 15px); justify-content: center; flex-wrap: wrap;">
                <button class="btn btn-host" id="jugar-de-nuevo-btn" style="flex: 1; min-width: 180px;">üîÑ S√≠, jugar de nuevo</button>
                <button class="btn btn-danger" id="salir-btn" style="flex: 1; min-width: 150px;">üè† No, salir</button>
            </div>
        </div>
    </div>

    <div class="game-layout">
        <!-- Columna Principal -->
        <div class="game-main">
            <!-- Header -->
            <div class="game-header">
            <div>
                    <p class="letra-display" id="letra-actual">?</p>
                    <p class="ronda-info" id="ronda-info-text">
                        Ronda <span id="ronda-texto">{{ ronda }}</span> de {{ total_rondas }} ‚Ä¢ 
                        <span id="jugador-nombre"></span>
                    </p>
                </div>
                
                <div class="timer-container">
                    <svg class="timer-circle" width="100" height="100">
                        <defs>
                            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#6366f1"/>
                                <stop offset="100%" style="stop-color:#8b5cf6"/>
                            </linearGradient>
                        </defs>
                        <circle class="timer-circle-bg" cx="50" cy="50" r="42"/>
                        <circle class="timer-circle-progress" 
                                id="timer-progress"
                                cx="50" cy="50" r="42"
                                stroke-dasharray="264"
                                stroke-dashoffset="0"/>
                    </svg>
                    <div class="timer-text" id="timer">180</div>
                </div>
            </div>

            <!-- Selector de Jugadores (Visible en Resultados) -->
            <div id="player-selector-container" style="display:none; background: rgba(255,255,255,0.9); padding: 15px; border-radius: var(--radius-lg); overflow-x: auto;">
                <h3 style="margin: 0 0 10px 0; font-size: 1em; color: var(--dark);">üëÅÔ∏è Ver respuestas de:</h3>
                <div id="player-selector" style="display: flex; gap: 10px; min-width: min-content;">
                    <!-- Botones se generan din√°micamente -->
                </div>
            </div>

            <!-- Categor√≠as -->
            <div class="game-card">
                <div class="categories-grid">
                    {% for cat in categorias %}
                    <div class="category-row" data-categoria="{{ cat.nombre }}">
                        <label class="category-label">
                            <span style="font-size: 1.3em;">{{ cat.icon }}</span>
                            {{ cat.nombre }}
                        </label>
                        <div style="flex: 1; display: flex; flex-direction: column; gap: 6px;">
                            <input type="text" 
                                   class="category-input campo" 
                                   data-categoria="{{ cat.nombre }}"
                                   placeholder="Escribe tu respuesta...">
                            <!-- √Årea de validaci√≥n IA -->
                            <div class="validacion-ia" data-categoria="{{ cat.nombre }}" style="display: none; align-items: center; gap: 8px; flex-wrap: wrap;">
                                <span class="badge-ia" style="font-size: 0.85em;"></span>
                                <button class="btn-apelar" data-categoria="{{ cat.nombre }}" style="display: none; padding: 4px 10px; font-size: 0.8em; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">‚ö†Ô∏è Apelar</button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Bot√≥n BASTA -->
            <button id="basta-btn" class="btn">üõë ¬°BASTA!</button>

            <!-- Panel de Resultados Integrado -->
            <div id="resultados-panel" style="display: none;" class="game-card">
                <h2 style="text-align: center; font-size: 1.8em; color: var(--primary); margin-bottom: 20px;">
                    üèÜ <span id="resultados-titulo">Resultados</span>
                </h2>
                
                <!-- Tabla de Puntuaciones -->
                <div id="resultados-puntuaciones" style="margin-bottom: 25px;"></div>
                
                <!-- Bot√≥n Continuar -->
                <button class="btn btn-host" id="btn-continuar" style="margin-top: 25px;">
                    Continuar ‚û°Ô∏è
                </button>
            </div>

            <div id="mensaje-final" style="display:none;"></div>

            <p style="text-align: center; margin-top: 20px;">
                <a href="/waiting/{{ codigo }}" class="link" style="color: white;">‚Üê Volver a la sala</a>
            </p>
        </div>
        
        <!-- Sidebar -->
        <div class="game-sidebar">
            <!-- Control de Sonidos -->
            <div style="padding: 12px; background: white; border-radius: var(--radius-md); box-shadow: var(--shadow-xl); display: flex; justify-content: space-between; align-items: center; border: 1px solid rgba(255, 255, 255, 0.3);">
                <span style="font-size: 0.9em; color: var(--dark); font-weight: 600;">üîä Sonidos</span>
                <label style="cursor: pointer;">
                    <input type="checkbox" id="sound-toggle" checked style="width: 20px; height: 20px; cursor: pointer;">
                </label>
            </div>
            
            <!-- Power-Ups -->
            {% if powerups_habilitados %}
            <div class="powerups-panel">
                <h3 class="powerups-title"><span>‚ö°</span>Power-Ups</h3>
                <div id="powerups-list">
                    <div class="powerup-item disabled" data-powerup="tiempo_extra">
                        <div class="powerup-info">
                            <span class="icon">‚è∞</span>
                            <span class="name">Tiempo Extra</span>
                        </div>
                        <span class="powerup-count">0</span>
                    </div>
                    <div class="powerup-item disabled" data-powerup="pista">
                        <div class="powerup-info">
                            <span class="icon">üí°</span>
                            <span class="name">Pista</span>
                        </div>
                        <span class="powerup-count">0</span>
                    </div>
                    <div class="powerup-item disabled" data-powerup="cambiar_letra">
                        <div class="powerup-info">
                            <span class="icon">üîÑ</span>
                            <span class="name">Cambiar Letra</span>
                        </div>
                        <span class="powerup-count">0</span>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Chat Mini -->
            {% if chat_habilitado %}
            <div class="chat-mini">
                <div class="chat-header-mini">üí¨ Chat</div>
                <div class="chat-messages-mini" id="chat-messages-mini"></div>
                <div class="chat-input-mini">
                    <input type="text" id="chat-input-mini" placeholder="Mensaje..." maxlength="100">
                    <button id="chat-send-mini">Enviar</button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

<script>
    const jugador = localStorage.getItem("jugador");
    const codigo = "{{ codigo }}";
    const total_rondas = {{ total_rondas }};
    const powerupsHabilitados = {{ powerups_habilitados|tojson }};
    const chatHabilitado = {{ chat_habilitado|tojson }};
    const validacionActiva = {{ validacion_activa|tojson }};
    
    if (!jugador || jugador === "null" || String(jugador).trim() === "") {
        window.location.replace("/join");
    }
    
    const socket = io();
    const bastaBtn = document.getElementById("basta-btn");
    const timerText = document.getElementById("timer");
    const timerProgress = document.getElementById("timer-progress");
    const inputs = document.querySelectorAll(".campo");
    const letraElemento = document.getElementById("letra-actual");
    const rondaTexto = document.getElementById("ronda-texto");
    const jugadorNombre = document.getElementById("jugador-nombre");
    const resultsOverlay = document.getElementById("results-overlay");
    const juegoFinalizadoMsg = document.getElementById("juego-finalizado-msg");
    const jugarDeNuevoBtn = document.getElementById("jugar-de-nuevo-btn");
    const salirBtn = document.getElementById("salir-btn");
    
    jugadorNombre.textContent = jugador;
    
    // Toggle de sonidos
    const soundToggle = document.getElementById("sound-toggle");
    if (soundToggle) {
        soundToggle.addEventListener("change", (e) => {
            if (typeof soundSystem !== 'undefined') {
                soundSystem.setEnabled(e.target.checked);
                if (e.target.checked) {
                    soundSystem.playButton();
                }
            }
        });
    }
    
    // Timer circular
    const circleRadius = 42;
    const circleCircumference = 2 * Math.PI * circleRadius;
    let tiempoTotal = 180;
    
    function actualizarTimerCircular(segundos) {
        const progreso = segundos / tiempoTotal;
        const offset = circleCircumference * (1 - progreso);
        timerProgress.style.strokeDashoffset = offset;
        
        if (segundos <= 30) {
            timerText.classList.add("warning");
        } else {
            timerText.classList.remove("warning");
        }
    }
    
    // Funci√≥n para guardar respuestas en localStorage
    function guardarRespuestas() {
        const respuestas = {};
        inputs.forEach(input => {
            const cat = input.getAttribute("data-categoria");
            respuestas[cat] = input.value.trim();
        });
        localStorage.setItem(`respuestas_${codigo}`, JSON.stringify(respuestas));
    }
    
    // Funci√≥n para recuperar respuestas de localStorage
    function recuperarRespuestas() {
        const respuestasGuardadas = localStorage.getItem(`respuestas_${codigo}`);
        if (respuestasGuardadas) {
            try {
                const respuestas = JSON.parse(respuestasGuardadas);
                inputs.forEach(input => {
                    const cat = input.getAttribute("data-categoria");
                    if (respuestas[cat]) {
                        input.value = respuestas[cat];
                        if (input.value.trim()) {
                            input.classList.add("filled");
                        }
                    }
                });
            } catch (e) {
                console.error("Error recuperando respuestas:", e);
            }
        }
    }
    
    // Recuperar respuestas al cargar la p√°gina
    recuperarRespuestas();
    
    // Detectar inputs llenos y guardar en localStorage
    inputs.forEach(input => {
        input.addEventListener("input", () => {
            if (input.value.trim()) {
                input.classList.add("filled");
            } else {
                input.classList.remove("filled");
            }
            guardarRespuestas(); // Guardar cada vez que se escribe
        });
    });
    
    // Chat
    if (chatHabilitado) {
        const chatMessages = document.getElementById("chat-messages-mini");
        const chatInput = document.getElementById("chat-input-mini");
        const chatSend = document.getElementById("chat-send-mini");
        
        function agregarMensajeChat(jugadorChat, mensaje, tipo = "usuario") {
            const msgDiv = document.createElement('div');
            
            // Aplicar clases seg√∫n el tipo de mensaje
            if (tipo === "sistema_moderacion") {
                msgDiv.className = 'chat-message-mini sistema-moderacion';
                msgDiv.style.cssText = `
                    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%) !important;
                    border: 2px solid #c0392b !important;
                    color: white !important;
                    font-weight: 600 !important;
                    animation: shakeError 0.5s ease-in-out !important;
                `;
            } else {
                msgDiv.className = 'chat-message-mini';
            }
            
            msgDiv.innerHTML = `
                <div class="author" style="${tipo === 'sistema_moderacion' ? 'color: #fff !important; font-weight: 700;' : ''}">${jugadorChat}</div>
                <div style="${tipo === 'sistema_moderacion' ? 'color: #fff !important;' : ''}">${mensaje}</div>
            `;
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function enviarMensaje() {
            const mensaje = chatInput.value.trim();
            if (!mensaje) return;
            
            socket.emit("enviar_mensaje_chat", {
                codigo: codigo,
                jugador: jugador,
                mensaje: mensaje
            });
            
            chatInput.value = '';
        }
        
        chatSend.addEventListener("click", enviarMensaje);
        chatInput.addEventListener("keypress", (e) => {
            if (e.key === "Enter") enviarMensaje();
        });
        
        socket.on("nuevo_mensaje_chat", (data) => {
            const tipo = data.tipo || "usuario";
            agregarMensajeChat(data.jugador, data.mensaje, tipo);
            
            // Sonido seg√∫n el tipo de mensaje
            if (typeof soundSystem !== 'undefined') {
                if (tipo === "sistema_moderacion") {
                    soundSystem.playError();  // Sonido de error para moderaci√≥n
                } else if (data.jugador !== jugador) {
                    soundSystem.playMessage();  // Sonido normal para mensajes de otros
                }
            }
        });
        
        // Manejar mensajes rechazados por el filtro
        socket.on("mensaje_rechazado", (data) => {
            mostrarNotificacion(`‚ùå ${data.razon}`);
            if (typeof soundSystem !== 'undefined') {
                soundSystem.playError();
            }
        });
    }
    
    // Power-ups
    if (powerupsHabilitados) {
        document.querySelectorAll('.powerup-item').forEach(item => {
            item.addEventListener('click', function() {
                if (this.classList.contains('disabled')) return;
                
                const powerup = this.dataset.powerup;
                socket.emit("usar_powerup", {
                    codigo: codigo,
                    jugador: jugador,
                    powerup: powerup
                });
            });
        });
        
        socket.on("powerup_usado", (data) => {
            mostrarNotificacion(`${data.mensaje}`);
            
            // Sonido de power-up
            if (typeof soundSystem !== 'undefined') {
                soundSystem.playPowerup();
            }
        });
        
        socket.on("letra_cambiada", (data) => {
            letraElemento.textContent = data.letra;
            mostrarNotificacion(`üîÑ ${data.jugador} cambi√≥ la letra a ${data.letra}!`);
        });
        
        socket.on("powerup_recibido", (data) => {
            if (data.jugador === jugador) {
                actualizarPowerup(data.powerup, data.cantidad);
            }
        });
    }
    
    function actualizarPowerup(powerup, cantidad) {
        const item = document.querySelector(`[data-powerup="${powerup}"]`);
        if (item) {
            const countSpan = item.querySelector('.powerup-count');
            countSpan.textContent = cantidad;
            
            if (cantidad > 0) {
                item.classList.remove('disabled');
            } else {
                item.classList.add('disabled');
            }
        }
    }
    
    function mostrarNotificacion(mensaje) {
        const notif = document.createElement('div');
        notif.textContent = mensaje;
        notif.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: var(--gradient-4);
            color: white;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 10000;
            font-weight: 600;
            animation: slideDown 0.3s ease-out;
        `;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }
    
    // Socket events
    socket.on("connect", () => {
        socket.emit("rejoin_room_event", { codigo: codigo, jugador: jugador });
    });

    socket.on("restore_state", data => {
        letraElemento.textContent = data.letra || "?";
        rondaTexto.textContent = data.ronda || 1;
        
        const tiempo = data.tiempo_restante || 0;
        timerText.textContent = tiempo;
        tiempoTotal = tiempo;
        actualizarTimerCircular(tiempo);
        
        // Restaurar estado de Basta/Pausa
        if (data.basta_activado) {
            bastaBtn.disabled = true;
            bastaBtn.textContent = "‚è±Ô∏è TIEMPO TERMINADO";
            inputs.forEach(input => input.disabled = true);
            // Mostrar overlay de validaci√≥n si corresponde (opcional, pero consistente)
            document.getElementById('validando-overlay').style.display = 'flex';
        } else if (data.pausada) {
            bastaBtn.disabled = true;
            bastaBtn.textContent = "‚è∏Ô∏è RONDA PAUSADA";
            inputs.forEach(input => input.disabled = true);
            timerText.textContent = "‚è∏Ô∏è";
            timerText.style.color = "#f59e0b";
        } else {
            // Estado normal
            bastaBtn.disabled = false;
            bastaBtn.textContent = "üõë ¬°BASTA!";
            inputs.forEach(input => input.disabled = false);
        }

        // Sonido al restaurar/iniciar
        if (typeof soundSystem !== 'undefined') {
            soundSystem.playStart();
        }
    });

    socket.on("update_timer", data => {
        const segundos = data.tiempo;
        const pausada = data.pausada || false;
        
        if (pausada) {
            timerText.textContent = "‚è∏Ô∏è";
            timerText.style.color = "#f59e0b";
            timerText.style.fontSize = "2em";
        } else {
            timerText.textContent = segundos;
            timerText.style.color = "";
            timerText.style.fontSize = "";
            actualizarTimerCircular(segundos);
            
            // Sonido de advertencia cuando queda poco tiempo
            if (segundos === 30 && typeof soundSystem !== 'undefined') {
                soundSystem.playWarning();
            }
            
            // Tick del reloj en los √∫ltimos 10 segundos
            if (segundos <= 10 && typeof soundSystem !== 'undefined') {
                soundSystem.playTick();
            }
        }
    });
    
    // Manejar pausa de ronda
    socket.on("ronda_pausada", data => {
        const pausada = data.pausada;
        const rondaInfoText = document.getElementById("ronda-info-text");
        
        if (pausada) {
            // Mostrar mensaje de pausa
            timerText.textContent = "‚è∏Ô∏è";
            timerText.style.color = "#f59e0b";
            timerText.style.fontSize = "2em";
            
            // Actualizar texto de ronda
            if (rondaInfoText) {
                rondaInfoText.innerHTML = '<span style="color: #f59e0b; font-weight: 700;">‚è∏Ô∏è RONDA PAUSADA</span>';
            }
            
            // Deshabilitar inputs y bot√≥n basta
            inputs.forEach(input => input.disabled = true);
            bastaBtn.disabled = true;
            bastaBtn.textContent = "‚è∏Ô∏è RONDA PAUSADA";
            
            // Mostrar notificaci√≥n
            mostrarNotificacion(data.mensaje || "Ronda pausada por administrador");
        } else {
            // Reanudar
            timerText.style.color = "";
            timerText.style.fontSize = "";
            
            // Restaurar texto de ronda
            if (rondaInfoText) {
                rondaInfoText.innerHTML = `Ronda <span id="ronda-texto">${rondaTexto.textContent}</span> de ${total_rondas} ‚Ä¢`;
            }
            
            inputs.forEach(input => input.disabled = false);
            bastaBtn.disabled = false;
            bastaBtn.textContent = "‚úã ¬°BASTA!";
            
            mostrarNotificacion(data.mensaje || "Ronda reanudada");
        }
    });
    
    // Manejar expulsi√≥n
    socket.on("jugador_expulsado", data => {
        if (data.jugador === jugador) {
            mostrarNotificacion("Has sido expulsado de la sala por el administrador");
            setTimeout(() => {
                window.location.href = "/";
            }, 2000);
        } else {
            mostrarNotificacion(data.mensaje);
        }
    });

    socket.on("basta_triggered", data => {
        bastaBtn.disabled = true;
        bastaBtn.textContent = "‚è±Ô∏è TIEMPO TERMINADO";
        inputs.forEach(input => input.disabled = true);
        enviarRespuestas();
        
        // Sonido dram√°tico de BASTA
        if (typeof soundSystem !== 'undefined') {
            soundSystem.playBasta();
        }
        
        // Mostrar overlay de validaci√≥n IA
        document.getElementById('validando-overlay').style.display = 'flex';
    });

        // Advertencia al salir de la p√°gina
    window.addEventListener('beforeunload', (e) => {
        if (partidaFinalizada) return; // No advertir si el juego ya termin√≥
        
        const mensaje = "Si sales ahora, abandonar√°s la partida en curso. ¬øEst√°s seguro?";
        e.returnValue = mensaje;
        return mensaje;
    });

    socket.on("round_results", data => {
        // Si la partida finaliz√≥, limpiar localStorage y marcar como finalizada
        if (data.fin_del_juego) {
            partidaFinalizada = true;
            localStorage.removeItem(`respuestas_${codigo}`);
            bastaBtn.disabled = true;
            bastaBtn.textContent = "üèÅ Partida Finalizada";
        }
        // Ocultar overlay de validaci√≥n
        document.getElementById('validando-overlay').style.display = 'none';
        
        // Mostrar resultados
        mostrarResultados(data);
    });

    // Ya no se usa: ahora se reasigna anfitri√≥n autom√°ticamente
    
    socket.on("nuevo_anfitrion", data => {
        const nuevoAnfitrion = data.nuevo_anfitrion;
        const mensaje = data.mensaje;
        
        // Mostrar notificaci√≥n
        mostrarNotificacion(mensaje);
        
        // Si yo soy el nuevo anfitri√≥n, activar controles
        if (nuevoAnfitrion === jugador) {
            // Mostrar notificaci√≥n especial
            mostrarNotificacion("üéâ ¬°Ahora eres el anfitri√≥n de la sala!");
        }
        
    });
    
    // Validaci√≥n
    if (validacionActiva) {
        socket.on("iniciar_votacion", (data) => {
            mostrarVotacion(data.jugador, data.categoria, data.respuesta);
        });
        
        socket.on("respuesta_invalidada", (data) => {
            mostrarNotificacion(`‚ùå Respuesta de ${data.jugador} invalidada (-${data.puntos_perdidos} puntos)`);
        });
        
        socket.on("respuesta_validada", (data) => {
            mostrarNotificacion(`‚úÖ Respuesta de ${data.jugador} validada`);
        });
    }
    
    // Eventos de Apelaci√≥n
    socket.on("iniciar_votacion_apelacion", (data) => {
        mostrarVotacionApelacion(data.jugador, data.categoria, data.respuesta);
    });
    
    socket.on("apelacion_aceptada", (data) => {
        const puntosText = data.puntos_ganados > 0 ? ` (+${data.puntos_ganados} puntos)` : '';
        mostrarNotificacion(`‚úÖ ¬°Apelaci√≥n aceptada! ${data.jugador} - ${data.categoria}: "${data.respuesta}"${puntosText}`);
        
        // Si soy el jugador que apel√≥, actualizar mi UI de validaci√≥n
        if (data.jugador === jugador) {
            const validacionDiv = document.querySelector(`.validacion-ia[data-categoria="${data.categoria}"]`);
            if (validacionDiv) {
                const categoryRow = validacionDiv.closest('.category-row');
                if (categoryRow && categoryRow.getAttribute('data-categoria') === data.categoria) {
                    const input = categoryRow.querySelector('.category-input');
                    if (input && input.value.trim().toLowerCase() === data.respuesta.toLowerCase()) {
                        const badgeIA = validacionDiv.querySelector('.badge-ia');
                        const btnApelar = validacionDiv.querySelector('.btn-apelar');
                        
                        const puntosHTML = data.puntos_ganados > 0 ? `<span style="display: inline-block; padding: 4px 10px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 12px; margin-left: 8px; font-weight: 700;">+${data.puntos_ganados} pts</span>` : '';
                        
                        if (badgeIA) {
                            badgeIA.innerHTML = `<span style="display: inline-block; padding: 4px 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 12px;">ü§ñ ‚úì V√°lido (Apelaci√≥n)</span>${puntosHTML}`;
                        }
                        if (btnApelar) {
                            btnApelar.style.display = 'none';
                        }
                    }
                }
            }
        }
        
        // Actualizar TODAS las puntuaciones en la tabla de resultados modal
        if (data.puntuaciones_totales) {
            // Actualizar cada fila de la tabla en el modal
            Object.entries(data.puntuaciones_totales).forEach(([nombreJugador, puntosTotal]) => {
                // Buscar la celda de puntos totales de este jugador en la tabla
                const rows = document.querySelectorAll('#resultados-puntuaciones-modal table tbody tr');
                rows.forEach(row => {
                    const nombreCell = row.querySelector('td:first-child strong');
                    if (nombreCell && nombreCell.textContent === nombreJugador) {
                        const totalCell = row.querySelector('td:last-child');
                        if (totalCell) {
                            const oldValue = parseInt(totalCell.textContent) || 0;
                            totalCell.textContent = puntosTotal;
                            
                            // Agregar animaci√≥n si cambi√≥
                            if (oldValue !== puntosTotal) {
                                totalCell.style.animation = 'pulse 0.5s ease-in-out';
                                setTimeout(() => {
                                    totalCell.style.animation = '';
                                }, 500);
                            }
                        }
                    }
                });
            });
        }
    });
    
    socket.on("apelacion_rechazada", (data) => {
        mostrarNotificacion(`‚ùå Apelaci√≥n rechazada: ${data.jugador} - ${data.categoria}: "${data.respuesta}"`);
    });
    
    let votacionActual = null;
    
    function mostrarVotacion(jugadorVotado, categoria, respuesta) {
        if (jugadorVotado === jugador) return; // No votar por ti mismo
        
        votacionActual = { jugador: jugadorVotado, categoria: categoria };
        
        document.getElementById("val-player").textContent = jugadorVotado;
        document.getElementById("val-category").textContent = categoria;
        document.getElementById("val-answer").textContent = respuesta;
        
        const modal = document.getElementById("validation-modal");
        modal.classList.add("show");
    }
    
    function votarValidacion(voto) {
        if (!votacionActual) return;
        
        const key = `${votacionActual.jugador}:${votacionActual.categoria}`;
        socket.emit("votar_validacion", {
            codigo: codigo,
            key: key,
            voto: voto,
            votante: jugador
        });
        
        document.getElementById("validation-modal").classList.remove("show");
        votacionActual = null;
    }

    // Verificar si la partida est√° finalizada
    let partidaFinalizada = false;
    
    socket.on("partida_finalizada", (data) => {
        partidaFinalizada = true;
        bastaBtn.disabled = true;
        bastaBtn.textContent = "üèÅ Partida Finalizada";
        mostrarNotificacion(data.mensaje || "La partida ya ha finalizado");
    });
    
    // Bot√≥n BASTA
    bastaBtn.addEventListener("click", () => {
        if (bastaBtn.disabled || partidaFinalizada) return;
        socket.emit("basta_pressed", { codigo: codigo });
        bastaBtn.disabled = true;
        bastaBtn.textContent = "‚è±Ô∏è ¬°BASTA! ACTIVADO";
    });

    function enviarRespuestas() {
        const respuestas = {};
        inputs.forEach(input => {
            const cat = input.getAttribute("data-categoria");
            respuestas[cat] = input.value.trim();
        });
        
        // Guardar en localStorage antes de enviar
        guardarRespuestas();
        
        socket.emit("enviar_respuestas", {
            codigo: codigo,
            jugador: jugador,
            respuestas: respuestas
        });
    }

    function mostrarResultados(data) {
        try {
            // Ocultar bot√≥n BASTA pero mantener formulario visible
            const bastaBtn = document.getElementById('basta-btn');
            if (bastaBtn) bastaBtn.style.display = 'none';
            
            // Deshabilitar inputs para que no se puedan editar
            inputs.forEach(input => {
                input.disabled = true;
            });
            
            // Mostrar respuestas y validaciones IA directamente en los campos de entrada
            if (data.respuestas && data.respuestas[jugador]) {
                const misRespuestas = data.respuestas[jugador];
                
                inputs.forEach(input => {
                    const categoria = input.getAttribute('data-categoria');
                    const respuesta = misRespuestas[categoria];
                    
                    // Mostrar respuesta en el input
                    if (respuesta) {
                        input.value = respuesta;
                    }
                    
                    // Mostrar validaci√≥n IA si existe
                    if (data.validaciones_ia && data.validaciones_ia[jugador] && data.validaciones_ia[jugador][categoria]) {
                        const validacionIA = data.validaciones_ia[jugador][categoria];
                        const validacionDiv = document.querySelector(`.validacion-ia[data-categoria="${categoria}"]`);
                        const badgeIA = validacionDiv?.querySelector('.badge-ia');
                        const btnApelar = validacionDiv?.querySelector('.btn-apelar');
                        
                        // Obtener puntos de esta respuesta
                        const puntos = data.puntos_por_respuesta?.[jugador]?.[categoria] || 0;
                        const puntosText = puntos > 0 ? `<span style="display: inline-block; padding: 4px 10px; background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%); color: white; border-radius: 12px; margin-left: 8px; font-weight: 700;">+${puntos} pts</span>` : '';
                        
                        if (validacionDiv && badgeIA) {
                            validacionDiv.style.display = 'flex';
                            
                            if (validacionIA.validada_ia) {
                                badgeIA.innerHTML = `<span style="display: inline-block; padding: 4px 10px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 12px;">ü§ñ ‚úì V√°lido</span>${puntosText}`;
                                if (btnApelar) btnApelar.style.display = 'none';
                            } else {
                                badgeIA.innerHTML = `<span style="display: inline-block; padding: 4px 10px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border-radius: 12px;">ü§ñ ‚úó Inv√°lido</span><br><span style="font-size: 0.85em; color: var(--gray); font-style: italic; margin-left: 5px;">‚Üí ${validacionIA.razon_ia || 'No v√°lido'}</span>`;
                                if (btnApelar) {
                                    btnApelar.style.display = 'inline-block';
                                    btnApelar.onclick = () => {
                                        const respuestaValue = respuesta || input.value.trim();
                                        apelarRespuesta(jugador, categoria, respuestaValue);
                                    };
                                }
                            }
                        }
                    }
                });
            }
            
        // Usar modal en lugar del panel integrado
        const resultadosTituloModal = document.getElementById('resultados-titulo-modal');
        const resultadosPuntuacionesModal = document.getElementById('resultados-puntuaciones-modal');
        const resultadosModal = document.getElementById('resultados-modal');
        
        // Detectar si somos anfitri√≥n
        const esAnfitrion = jugador === data.anfitrion || localStorage.getItem("jugador") === data.anfitrion;
        const modoEquipos = data.modo_juego === "equipos" && data.equipos && Object.keys(data.equipos).length > 0;
            
            if (data.fin_del_juego) {
                resultadosTituloModal.textContent = "¬°Juego Finalizado!";
            } else {
                resultadosTituloModal.textContent = `Resultados - Ronda ${data.ronda}`;
            }
        
        let html = '';
        
        // Si es modo equipos, mostrar resultados de equipos primero
        if (modoEquipos) {
            html += '<h3 style="margin: 20px 0 15px 0; color: var(--dark);">‚öΩ Puntuaciones por Equipos</h3>';
            html += '<table style="width: 100%; border-collapse: separate; border-spacing: 0 10px; margin-bottom: 25px;"><thead><tr><th style="padding: 15px; background: var(--gradient-3); color: white; text-align: left; font-weight: 700;">Equipo</th><th style="padding: 15px; background: var(--gradient-3); color: white; text-align: right; font-weight: 700;">Total</th></tr></thead><tbody>';
            
            const equiposOrdenados = Object.entries(data.puntuaciones_equipos)
                .sort(([, a], [, b]) => b - a);
            
            equiposOrdenados.forEach(([nombreEquipo, puntos], index) => {
                const color = nombreEquipo.includes('A') ? 'var(--primary)' : 'var(--success)';
                const badge = index === 0 ? '<span style="display: inline-block; padding: 4px 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 20px; font-size: 0.85em; font-weight: 700; margin-left: 8px;">üèÜ Ganando</span>' : '';
                html += `
                    <tr style="background: white; border-radius: var(--radius-md); border-left: 4px solid ${color};">
                        <td style="padding: 15px; border-bottom: 1px solid var(--light);"><strong style="color: ${color};">${nombreEquipo}</strong>${badge}</td>
                        <td style="padding: 15px; color: ${color}; font-weight: 700; font-size: 1.3em; border-bottom: 1px solid var(--light); text-align: right;">${puntos}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            html += '<h3 style="margin: 20px 0 15px 0; color: var(--dark);">üë• Puntuaciones Individuales</h3>';
        }
        
        html += '<table style="width: 100%; border-collapse: separate; border-spacing: 0 10px;"><thead><tr><th style="padding: 15px; background: var(--gradient-1); color: white; text-align: left; font-weight: 700;">Jugador</th><th style="padding: 15px; background: var(--gradient-1); color: white; text-align: left; font-weight: 700;">Puntos Ronda</th><th style="padding: 15px; background: var(--gradient-1); color: white; text-align: left; font-weight: 700;">Total</th></tr></thead><tbody>';
        
        const jugadoresOrdenados = Object.entries(data.scores_total)
            .sort(([, a], [, b]) => b - a);
        
        jugadoresOrdenados.forEach(([jugadorNombre, scoreTotal], index) => {
            const scoreRonda = data.scores_ronda[jugadorNombre] || 0;
            
            // Mostrar equipo si es modo equipos
            let equipoTag = '';
            if (modoEquipos) {
                for (const [nombreEquipo, miembros] of Object.entries(data.equipos)) {
                    if (miembros.includes(jugadorNombre)) {
                        const color = nombreEquipo.includes('A') ? 'var(--primary)' : 'var(--success)';
                        equipoTag = `<span style="display: inline-block; padding: 2px 8px; background: ${color}; color: white; border-radius: 10px; font-size: 0.75em; margin-left: 8px;">${nombreEquipo}</span>`;
                        break;
                    }
                }
            }
            
            const badge = (!modoEquipos && index === 0) ? '<span style="display: inline-block; padding: 4px 12px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border-radius: 20px; font-size: 0.85em; font-weight: 700; margin-left: 8px;">üëë L√≠der</span>' : '';
            html += `
                <tr style="background: white; border-radius: var(--radius-md);">
                    <td style="padding: 15px; border-bottom: 1px solid var(--light);"><strong>${jugadorNombre}</strong>${equipoTag}${badge}</td>
                    <td style="padding: 15px; color: var(--success); font-weight: 700; border-bottom: 1px solid var(--light);">+${scoreRonda}</td>
                    <td style="padding: 15px; color: var(--primary); font-weight: 700; font-size: 1.2em; border-bottom: 1px solid var(--light);">${scoreTotal}</td>
                </tr>
            `;
        });
        
        html += '</tbody></table>';
        
        if (data.fin_del_juego) {
            // Verificar si todos tienen 0 puntos (no hay ganador)
            if (data.sin_ganador) {
                html += `<div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(156, 163, 175, 0.2) 0%, rgba(107, 114, 128, 0.2) 100%); border: 2px solid #6b7280; border-radius: var(--radius-lg); text-align: center;">
                            <h3 style="margin: 0; color: #4b5563;">ü§ù No hay ganador</h3>
                            <p style="margin: 10px 0 0 0; color: var(--dark);">Todos los jugadores tienen 0 puntos</p>
                         </div>`;
            } else {
                let ganadorTexto = '';
                if (modoEquipos) {
                    const equiposOrdenados = Object.entries(data.puntuaciones_equipos)
                        .sort(([, a], [, b]) => b - a);
                    ganadorTexto = `üèÜ Equipo Ganador: ${equiposOrdenados[0][0]}`;
                } else {
                    ganadorTexto = `üèÜ Ganador: ${jugadoresOrdenados[0][0]}`;
                }
                
                html += `<div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(6, 182, 212, 0.2) 100%); border: 2px solid var(--success); border-radius: var(--radius-lg); text-align: center;">
                            <h3 style="margin: 0; color: var(--success-dark);">${ganadorTexto}</h3>
                            <p style="margin: 10px 0 0 0; color: var(--dark);">¬°Felicidades!</p>
                         </div>`;
                crearConfeti();
                
                // Fanfarria de victoria
                if (typeof soundSystem !== 'undefined') {
                    soundSystem.playVictory();
                }
            }
        }
        
        // Mostrar puntuaciones en el modal
        resultadosPuntuacionesModal.innerHTML = html;
        
        // Guardar datos globales para la revisi√≥n
        currentResultsData = data;

        // Configurar Selector de Jugadores
        const selectorContainer = document.getElementById('player-selector-container');
        const selector = document.getElementById('player-selector');
        
        if (selector && selectorContainer) {
            selector.innerHTML = '';
            selectorContainer.style.display = 'block';
            
            Object.keys(data.respuestas).forEach(nombre => {
                const btn = document.createElement('button');
                btn.textContent = nombre;
                btn.className = 'player-select-btn';
                btn.style.cssText = `
                    padding: 8px 16px;
                    border-radius: 20px;
                    border: none;
                    background: #e5e7eb;
                    color: var(--dark);
                    font-weight: 600;
                    cursor: pointer;
                    transition: all 0.2s;
                    white-space: nowrap;
                `;
                
                btn.onclick = () => verRespuestasDe(nombre);
                selector.appendChild(btn);
            });
        }

        // Mostrar el modal con animaci√≥n
        resultadosModal.style.display = 'flex';
        
        // Configurar bot√≥n "Ver Respuestas Detalladas" -> Ahora "Revisar Respuestas"
        const btnVerDetalle = document.getElementById('btn-ver-detalle');
        const btnVolverResultados = document.getElementById('btn-volver-resultados');
        
        if (btnVerDetalle) {
            btnVerDetalle.innerHTML = "üîç Revisar Respuestas";
            btnVerDetalle.onclick = () => {
                // Ocultar modal de resultados
                resultadosModal.style.display = 'none';
                // Mostrar bot√≥n flotante para volver
                btnVolverResultados.style.display = 'block';
                // Scroll al inicio
                window.scrollTo({ top: 0, behavior: 'smooth' });
                
                // Activar vista del propio jugador por defecto
                verRespuestasDe(jugador);
            };
        }
        
        // Configurar bot√≥n flotante para volver a ver puntuaciones
        if (btnVolverResultados) {
            btnVolverResultados.onclick = () => {
                // Mostrar modal de resultados nuevamente
                resultadosModal.style.display = 'flex';
                // Ocultar bot√≥n flotante
                btnVolverResultados.style.display = 'none';
            };
        }
        
        // Configurar bot√≥n continuar del modal
        const btnContinuarModal = document.getElementById('btn-continuar-modal');
        if (btnContinuarModal) {
            if (data.fin_del_juego) {
                btnContinuarModal.textContent = 'üéâ Ver pantalla final';
                btnContinuarModal.onclick = () => {
                    resultadosModal.style.display = 'none';
                    btnVolverResultados.style.display = 'none';
                    document.getElementById('juego-finalizado-msg').style.display = 'flex';
                };
            } else {
                btnContinuarModal.textContent = 'Continuar ‚û°Ô∏è';
                btnContinuarModal.onclick = () => {
                    // Ocultar modal de resultados y bot√≥n flotante
                    resultadosModal.style.display = 'none';
                    btnVolverResultados.style.display = 'none';
                    // Mantener inputs deshabilitados pero visibles con validaciones
                    // El anfitri√≥n iniciar√° la siguiente ronda
                    window.location.href = `/waiting/${codigo}`;
                };
            }
        }
        
        } catch (error) {
            console.error("‚ùå Error mostrando resultados:", error);
            mostrarNotificacion("Error mostrando resultados. Recarga la p√°gina.");
        }
    }
    
    // Funci√≥n para apelar una respuesta
    function apelarRespuesta(jugadorResp, categoria, respuesta) {
        mostrarNotificacion(`‚ö†Ô∏è Solicitud de apelaci√≥n enviada: ${categoria} - ${respuesta}`);
        socket.emit("solicitar_apelacion", {
            codigo: codigo,
            jugador: jugadorResp,
            categoria: categoria,
            respuesta: respuesta
        });
    }
    
    // Variable para almacenar la apelaci√≥n actual
    let apelacionActual = null;
    let currentResultsData = null; // Datos de resultados para navegaci√≥n

    // Funci√≥n para cambiar la vista de respuestas de un jugador
    function verRespuestasDe(nombreJugador) {
        if (!currentResultsData) return;

        // Actualizar botones activos
        document.querySelectorAll('.player-select-btn').forEach(btn => {
            if (btn.textContent === nombreJugador) {
                btn.style.background = 'var(--primary)';
                btn.style.color = 'white';
            } else {
                btn.style.background = '#e5e7eb';
                btn.style.color = 'var(--dark)';
            }
        });

        // Actualizar t√≠tulo
        const jugadorNombreLabel = document.getElementById("jugador-nombre");
        if (jugadorNombreLabel) {
            if (nombreJugador === jugador) {
                 jugadorNombreLabel.textContent = `${nombreJugador} (T√∫)`;
            } else {
                 jugadorNombreLabel.innerHTML = `Viendo a: <span style="color: var(--primary); font-weight: 800;">${nombreJugador}</span>`;
            }
        }

        const respuestasJugador = currentResultsData.respuestas[nombreJugador] || {};
        const validacionesJugador = currentResultsData.validaciones_ia[nombreJugador] || {};
        const puntosJugador = currentResultsData.puntos_por_respuesta[nombreJugador] || {};

        inputs.forEach(input => {
            const categoria = input.getAttribute('data-categoria');
            const respuesta = respuestasJugador[categoria] || "";
            
            // Actualizar valor (inputs ya est√°n disabled)
            input.value = respuesta;

            // Actualizar validaci√≥n visual
            const validacionDiv = document.querySelector(`.validacion-ia[data-categoria="${categoria}"]`);
            const badgeIA = validacionDiv?.querySelector('.badge-ia');
            const btnApelar = validacionDiv?.querySelector('.btn-apelar');
            
            if (validacionDiv) {
                // Limpiar estado anterior
                validacionDiv.style.display = 'none';
                
                if (respuesta) {
                     validacionDiv.style.display = 'flex';
                     const validacion = validacionesJugador[categoria];
                     const puntos = puntosJugador[categoria] || 0;
                     const puntosText = puntos > 0 ? ` <span style="font-weight:800; color: #10b981;">(+${puntos})</span>` : '';

                     if (validacion && validacion.validada_ia) {
                         badgeIA.innerHTML = `ü§ñ ‚úì V√°lido ${puntosText}`;
                         badgeIA.style.color = '#10b981';
                         if(btnApelar) btnApelar.style.display = 'none';
                     } else if (validacion) {
                         badgeIA.innerHTML = `ü§ñ ‚úó Inv√°lido <span style="font-size:0.8em; color:gray">(${validacion.razon_ia})</span>`;
                         badgeIA.style.color = '#ef4444';
                         
                         // Solo mostrar bot√≥n apelar si:
                         // 1. Estamos viendo nuestras propias respuestas
                         // 2. Es apelable
                         if (nombreJugador === jugador && btnApelar) {
                             btnApelar.style.display = 'inline-block';
                         } else if (btnApelar) {
                             btnApelar.style.display = 'none';
                         }
                     } else {
                         // Sin validaci√≥n (ej. respuesta vac√≠a o no procesada)
                          badgeIA.innerHTML = '';
                          if(btnApelar) btnApelar.style.display = 'none';
                     }
                }
            }
        });
    }
    
    // Funci√≥n para mostrar el modal de votaci√≥n de apelaci√≥n
    function mostrarVotacionApelacion(jugadorApela, categoria, respuesta) {
        // No votar si eres el que apela
        if (jugadorApela === jugador) {
            mostrarNotificacion("‚è≥ Esperando votos de los dem√°s jugadores...");
            return;
        }
        
        apelacionActual = { jugador: jugadorApela, categoria: categoria };
        
        document.getElementById("apel-player").textContent = jugadorApela;
        document.getElementById("apel-category").textContent = categoria;
        document.getElementById("apel-answer").textContent = respuesta;
        
        const modal = document.getElementById("apelacion-modal");
        modal.classList.add("show");
    }
    
    // Funci√≥n para votar en una apelaci√≥n
    function votarApelacion(voto) {
        if (!apelacionActual) return;
        
        const key = `${apelacionActual.jugador}:${apelacionActual.categoria}`;
        socket.emit("votar_apelacion", {
            codigo: codigo,
            key: key,
            voto: voto,
            votante: jugador
        });
        
        document.getElementById("apelacion-modal").classList.remove("show");
        mostrarNotificacion("‚úì Tu voto ha sido registrado");
        apelacionActual = null;
    }

    function volverASala() {
        window.location.href = `/waiting/${codigo}`;
    }
    
    function volverAlMenu() {
        // Limpiar localStorage
        localStorage.removeItem("jugador");
        localStorage.removeItem("codigo");
        window.location.href = "/";
    }
    
    // Bot√≥n "Jugar de Nuevo" - vuelve a la sala de espera
    jugarDeNuevoBtn.addEventListener("click", volverASala);
    
    // Bot√≥n "Salir" - vuelve al men√∫ principal
    salirBtn.addEventListener("click", volverAlMenu);

    function crearConfeti() {
        const colores = ['#6366f1', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confeti = document.createElement('div');
                confeti.style.cssText = `
                    position: fixed;
                    width: 10px;
                    height: 10px;
                    background: ${colores[Math.floor(Math.random() * colores.length)]};
                    left: ${Math.random() * 100}%;
                    top: -10px;
                    animation: confetti-fall 3s linear;
                `;
                document.body.appendChild(confeti);
                setTimeout(() => confeti.remove(), 3000);
            }, i * 30);
        }
    }
    
    const style = document.createElement('style');
    style.textContent = `
        @keyframes confetti-fall {
            to {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        @keyframes shakeError {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
    `;
    // ==========================================
    // RESTAURACI√ìN DE ESTADO
    // ==========================================
    document.addEventListener('DOMContentLoaded', () => {
        const lastResults = {{ last_results|tojson if last_results else 'null' }};
        const isFinished = {{ 'true' if finalizada else 'false' }};
        
        if (isFinished) {
             console.log("üèÅ Partida restaurada en estado finalizado");
             partidaFinalizada = true;
             const bastaBtn = document.getElementById('basta-btn');
             if (bastaBtn) {
                 bastaBtn.disabled = true;
                 bastaBtn.textContent = "üèÅ Partida Finalizada";
             }
        }

        if (lastResults) {
            console.log("üîÑ Restaurando resultados de la √∫ltima ronda...", lastResults);
            
            // Ocultar overlay de validaci√≥n si existe
            const valOverlay = document.getElementById('validando-overlay');
            if (valOverlay) valOverlay.style.display = 'none';
            
            // Restaurar vista de resultados
            mostrarResultados(lastResults);
        }
    });

    document.head.appendChild(style);
</script>
</body>
</html>
